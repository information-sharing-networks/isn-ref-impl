<div class="col-lg-9" role="main">
    <div class="h-card card">
        <div class="card-header">
            <h1>Documentation</h1>
        </div>
        <div class="card-body">
            <p class="p-note card-text">Describes how to use your ISN and it's network site, participant sites and
                mirrors.</p>
        </div>
    </div>

    <div class="h-card card">
        <div class="card-header">
            <h1>What is an ISN?</h1>
        </div>
        <div class="card-body">
            <p>ISNs are general purpose information sharing networks (extensible to be useful within many domains). They
                are multilateral by default but do permit bilateral information sharing.</p>
            <p>Every participant (consortium, organisation or person) in an ISN has a site (with their own URI) to
                which they can publish
                signals. Signals may be syndicated via paramater (as they are contributed) to a specified mirror (a
                mirror may be provided as part of this demonstrator ISN).</p>
            <p>Where access control is configured accordingly participants may contribute signals to that site or view the signals contributed by others by
                logging in to other participant sites.</p>
            <p>Any ISN participant can reply to a signal contributed by another - this allows additional information related to the original signal
                - corrections, opinions, claims, attestation etc - to be captured.
                The <a href="https://www.w3.org/TR/webmention/" target="_blank">W3C Webmention</a> protocol is
                used in this reference example ISN to permit authenticated parties to associate their
                replies to signals on the site of those who contribute them (and on any mirror
                sites which have been setup within the ISN). </p>
            <p>Information within ISNs is represented via the <a
                    href="https://github.com/information-sharing-networks/signals/blob/main/README.md#signal-definition">signals
                    protocol</a> internally.
                For interoperabililty purposes the signal implementation selected for the demonstrator ISNs is a <a
                    href="https://microformats.org/wiki/h-event" target="_blank">Microformat 2
                    'event'</a>.
            </p>
        </div>
    </div>

    <div class="h-card card">
        <div class="card-header">
            <h2>ISN building blocks</h2>
        </div>
        <div class="card-body">
            <p>An ISN is comprised of four building blocks:</p>
            <ul>
                <li>ISN participant sites which participants use to publish signals into the ISN</li>
                <li>A governance framework which sets out how the ISN and its participants are to operate (this may be
                    one of a number of pluggable variants e.g. Collaboration Agreement)</li>
                <li>An optional ISN network site (which is the entry point into the ISN and provides detail on participants
                    sites, mirrors and the intent behind the ISN etc). </li>
                <li>One or more optional ISN mirror sites (mirror sites gather signals of various
                    categories which are syndicated to it by ISN participants. These sites can help to simplify the process for participants
                    looking to subscribe to signals).</li>
            </ul>
	    <p>Because network and mirrors sites are optional, an ISN may consist entirely of Participant Sites running in a peer mode (e.g. the network is in a 'peer2peer setup').</p>
        </div>
    </div>

    <div class="h-card card">
        <div class="card-header">
            <h2>ISN Network Executive Committee</h2>
        </div>
        <div class="card-body">
            <h3 class="card-title">Getting Started</h3>
            <p>As a member of the ISN Network Executive Committee you will mostly be administering one or more
                ISNs.</p>
            <h4 class="card-title">Setup</h4>
            <p>
                TODO: TBD
            </p>
        </div>
    </div>
    <div class="h-card card">
        <div class="card-header">
            <h2 class="card-title">Authenticating on a particpant site</h2>
        </div>
        <div class="card-body">
            <p>Only authenticated organisations can contribute signals (using Micropub API or Client) into the ISN via
                <a href="https://www.w3.org/TR/indieauth/" target="_blank">W3C Indieauth (OAuth-2)</a>.

                in the reference ISN implementation github is used as the indieauth authentication provider:
             </p>
            <ol>
                <li>
                Your participant site domain name is used to sign-in to both your own site and other participant sites you have permission to use.
                </li>
                <li>
                When you login to a participant site using your domain name, the ISN webapp running on the server will request an authorisaton endpoint from the 
                specified domain (this is specified in the config.edn file installed on your server). The ISN webapp then redirects the User to their authorization endpoint.
                </li>
                <li>
                The github authentication provider will authenticate login requests when a reference to the particpant site being used to login is present on the User's github profile page.
                (The link on the github home page should contain a rel="me" property: <br>
                 &lt;a href="https://isnsite.example.org" rel="me"&gt;isnsite.example.com&lt;/a&gt; 
                 <br>
                ... one way to add this is to create a new "social link" in your github profile) 
                </li>
                <li>
                The authorization endpoint issues a temporary authorization code, and sends it to the ISN webapp.
                </li>
                <li>
                The app checks the code with the authorization endpoint, and if the code is valid and if the userâ€™s identifier matches the identifier the authorization endpoint gives, 
                the login is completed and the user can use the webapp.
                </li>
            </ol>

            <p>
                once you have authenticated on your own participant site you can retrieve the bearer token needed to use the ISN API.  
                This token can be used to submit or retrieve signals from other sites where your site have been added as a contributer.
            </p>
            <p>
                You can also use your token with the ISN site Micropub endpoint to make changes to your site configuration
            </p>
            <p>For example to onboard a new ISN participant</p>
            <pre><code>curl -i -X POST -d h=event -d category=isn-membership-participant-update -d category=isn@sample-isn.my-example.xyz -d "name=acme.my-example.xyz" -d "summary=added to ISN" -H "Authorization: Bearer XXX" https://your-isn-site.my-example.xyz/micropub</code></pre>
            <p>For example to add a new mirror</p>
            <pre><code>curl -i -X POST -d h=event -d category=isn-membership-mirror-update -d category=isn@sample-isn.my-example.xyz -d "name=sample-isn-mirror.my-example.xyz" -d "summary=added to ISN" -H "Authorization: Bearer XXX" https://your-isn-site.my-example.xyz/micropub</code></pre>
            <p> 
                these POST requests should be made with with content type "application/x-www-form-urlencoded"
            </p>
        </div>
    </div>

    <div class="h-card card">
        <div class="card-header">
            <h2>ISN participants</h2>
        </div>
        <div class="card-body">
            <h4 class="card-title">Viewing signals</h4>
            <p>Only authenticated organisations can see signals on any ISN site or syndicator site (mirror) whether the
                ISN. This ISN is open, multilateral by default but does
                permit bilateral self sovereign information sharing.</p>

            <p>You can view signals in three ways:</p>
            <ul>
                <li>Going to the <a href="/">home page</a> of your ISN site</li>
                <li>Viewing signals using the API</li>
                <li>Using any Microsub Reader client you have set up to receive notifications on new signals (TODO: to
                    be documented)</li>
            </ul>

            <h5 class="card-title">Viewing signals with the API</h5>
            <p>
                You will need a bearer token (API) or to authenticate (ISN Site webapp) to view either synthesised
                signals or live ones in this demonstrator ISN.
            </p>
            <pre><code>curl -i -H "Authorization: Bearer xxxxx" https://your-isn-site.my-example.xyz/signals</code></pre>
	    <p>This will return a collection of all signals from ISNs you are authorised to interact with sorted by <a href="https://github.com/information-sharing-networks/signals/blob/main/README.md#example-1---the-simplest-possible-signal" target="_blank">correlation-id</a>. N.B. it may be unwise to query for all signals without filtering in some way (e.g. ISN, provider or within a window of time) as there could be a large nuber of signals.</p>
            <p>
               You can filter signals using query parameters. Filtering is a flexible mechanism an example is provided below combining a number of filters.
            </p>
            <pre><code>curl -i -H "Authorization: Bearer xxxx" https://your-isn-site.my-example.xyz/signals?isn=sample-isn-1.my-example.xyz\&provider=x\&countryCode=y</code></pre>
            <p>Signals can be filtered by any of the metadata fields per the Signals specification including by a single category. At the time of writing there is no way to filter by multiple categories.</p>
	    <p>It is possible to filter signals by isn in the event that as a participant you are a member of multiple ISNs. an 'isn' filter may be used and you must pass as the value an ISN domain including an 'isn@' prefix as part of the authority (e.g. isn=isn@sample-isn.my-example.xyz).</p>
	    <p>It is possible to filter signals to only include those with a published date-time between two date-times. These date range filters can be stacked on top of standard filters as documented previously.</p>
	    <pre><code>curl -i -H "Authorization: Bearer xxxx" https://your-isn-site.my-example.xyz/signals?from=2024-02-02T07:00:00.00Z\&to=2024-02-02T08:00:00.00Z</code></pre>
	    <p>The above example will return signals published on the 2nd Feb between 07:00 and 08:00 inclusive. The &amp; is escaped as the curl command is run in the terminal.</p>

            <h4 class="card-title">Creating a signal</h4>
	    <p>More detailed examples for creating signals (including optionality of fields) can be found in your ISN Github Repository in the 'sample-signal-creation' document. In this documentation we outline the basics.</p>
            <p>Only authenticated organisations can contribute signals (see above for details). This ISN does
                not trace contributed signals back to end users - part of what we
                are doing is exploring ways to move information that do not experience the same level of information
                governance friction.
            </p>
            <p>
                Once you have a bearer token (which you can retrieve using the 'account' tab in this site) you can use your ISN site Micropub endpoint to contribute signals via API
                with content type application/x-www-form-urlencoded similar to the below.
            </p>
            <pre><code>curl -i -X POST -d h=event -d "name=nuts" -d "summary=a predicate based on nuts" -d category=domain -d category=isn@sample-isn.my-example.xyz -H "Authorization: Bearer xxxxx" https://your-isn-site.my-example.xyz/micropub</code></pre>
            <p>
                This will create the simplest possible signal under the home page on your ISN site. Technically you could choose not to specify the first category but it is useful to annotate signals with domain specific categories. The second category is required and indicates that this signal is part of a specific ISN.
            </p>
            <p>
                Possibilities for attributes are listed below:
            </p>

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Attribute</th>
                        <th>Description</th>
                        <th>Optionality</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>h</td>
                        <td>Indicates the post type we are creating - for signals this is 'event'</td>
                        <td>Required</td>
                    </tr>
                    <tr>
                        <td>name</td>
                        <td>A human readable name for the signal. This is the 'object' of the signal. E.G. 'nuts'</td>
                        <td>Required</td>
                    </tr>
                    <tr>
                        <td>summary</td>
                        <td>A human readable name for the signal.</td>
                        <td>Required</td>
                    </tr>
                    <tr>
                        <td>description</td>
                        <td>Permits structured data to be passed in to the signal separated by a '^' character. E.G.
                            cn-code=XXX^container-id=YYY^countryCode=GB^correlation-id=5cd2e7db-8c56-4514-b6c5-bde69ce66604.
                            N.B.
                            correlation-id is an important element of structured data if not present it is created by
                            the system,
                            when passed in like in this example it is used to attach information to an existing signal 'thread'.
                        </td>
                        <td>Optional</td>
                    </tr>
                    <tr>
                        <td>start</td>
                        <td>Signals may has a start date (ISO 8601) - this can be passed in per '2023-02-07T21:00:00Z'.</td>
                        <td>Optional</td>
                    </tr>
                    <tr>
                        <td>end</td>
                        <td>Every signal has an end or expiry date (ISO 8601) - if not provided in the API call the
                            default in terms of days from now is configured for an organisations ISN site per signal. This can be
                            passed in per '2023-02-07T21:00:00Z' or '2023-02-07 21:00:00'.</td>
                        <td>Optional</td>
                    </tr>
                    <tr>
                        <td>location</td>
                        <td>Typically a significant point on the goods journey - but this could be set to indicate a
                            system from where a signal originates e.g. signals.my-example.xyz_system-x (see 'providerMapping' in the Signals spec).</td>
                        <td>Optional</td>
                    </tr>
                    <tr>
                        <td>category</td>
                        <td>The category for this signal. There are typically two uses of this field - domain specific signal categories and isn identifiers. An example of a domain specific category is 'pre-notification' indicating the signal is a pre-notification. An example of an isn identifier is 'isn@sample-isn-1.my-example.xyz'. It is the combination of these two cateories which determines the required fields in the payload which is captured in the description field. You can check your ISN Github repository to see which signals are defined and how they are configured, there you will find the sample-signal-creation document helpful along with the other documents.</td>
                        <td>Required</td>
                    </tr>
                </tbody>
            </table>

	    <h4 class="card-title">Receiving signals via Server Sent Events</h4>
	    <p>As an ISN participant you can subscribe to a stream of Signal Server Sent Events. This will ensure you have access without polling to a sequence of signals you have not processed or received before.</p>
	    <p>As with the API above each signal will have a correlation-id you can use to establish whether there is a chain of intelligence attached to the curent signal.</p>
	    <p>The SSE stream endpoint requires a bearer token and two path parameters:</p>
	    <ul>
              <li>client - a client identifier which should be used by all SSE clients you deploy at your site (e.g. acm in the case of Acme</li>
	      <li>connection-uid - a UUID which distinguishes a client you deploy from any other</li>
	    </ul>
	    <pre><code>curl -i -H "Authorization: Bearer xxxx" https://your.isn-site.xyz/stream/sse/acme/a-long-uuid</code></pre>
	    <p>If your subscription succeeds you will receive an SSE event confirming this with the following content:</p>
	    <pre><code>event: log-msg
data: Client has subscribed to ISN SSE stream</pre></code>
	    <p>From now on whenever a signal is created on a site within the ISN you will receive an SSE event detailing it.</p>
	    <p>TODO: currently all signals created within the network will be sent to you subscription filters are TBD</p>
        </div>
    </div>
</div>
